name: Build VCAM Test (iOS 14.6 Compatible)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  THEOS: /opt/theos
  CACHE_VERSION: v1

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: true

    # ============================================
    # ç¼“å­˜ç­–ç•¥ï¼šåŠ é€Ÿæ„å»º
    # ============================================
    - name: Cache Theos Framework
      id: cache-theos
      uses: actions/cache@v4
      with:
        path: /opt/theos
        key: theos-${{ env.CACHE_VERSION }}-${{ runner.os }}-${{ hashFiles('.github/workflows/build.yml') }}
        restore-keys: |
          theos-${{ env.CACHE_VERSION }}-${{ runner.os }}-

    - name: Cache ldid Binary
      id: cache-ldid
      uses: actions/cache@v4
      with:
        path: /usr/local/bin/ldid
        key: ldid-${{ env.CACHE_VERSION }}-${{ runner.os }}-v2.1.5-procursus2

    # ============================================
    # å®‰è£…åŸºç¡€ä¾èµ–
    # ============================================
    - name: Setup Build Environment
      run: |
        echo "=== è®¾ç½®æ„å»ºç¯å¢ƒ ==="
        sudo apt-get update -y
        sudo apt-get install -y build-essential git curl wget unzip fakeroot file perl python3
        echo "âœ… åŸºç¡€å·¥å…·å®‰è£…å®Œæˆ"

    # ============================================
    # å®‰è£… ldidï¼ˆä»£ç ç­¾åå·¥å…·ï¼‰
    # ============================================
    - name: Install ldid
      if: steps.cache-ldid.outputs.cache-hit != 'true'
      run: |
        echo "=== å®‰è£… ldid ==="
        LDID_VERSION="v2.1.5-procursus2"
        LDID_URL="https://github.com/ProcursusTeam/ldid/releases/download/${LDID_VERSION}/ldid_linux_x86_64"
        
        if curl -L --max-time 60 -o /tmp/ldid "$LDID_URL"; then
          if file /tmp/ldid | grep -q "ELF.*executable"; then
            sudo mv /tmp/ldid /usr/local/bin/ldid
            sudo chmod +x /usr/local/bin/ldid
            echo "âœ… ldid å®‰è£…æˆåŠŸ"
          else
            echo "âŒ ldid æ–‡ä»¶æ— æ•ˆ"
            exit 1
          fi
        else
          echo "âŒ ldid ä¸‹è½½å¤±è´¥"
          exit 1
        fi

    - name: Verify ldid
      run: |
        if command -v ldid >/dev/null 2>&1; then
          echo "âœ… ldid å¯ç”¨: $(which ldid)"
          ldid 2>&1 | head -3 || true
        else
          echo "âŒ ldid ä¸å¯ç”¨"
          exit 1
        fi

    # ============================================
    # ä½¿ç”¨å®˜æ–¹ Theos å®‰è£…å™¨
    # ============================================
    - name: Install Theos
      if: steps.cache-theos.outputs.cache-hit != 'true'
      run: |
        echo "=== ä½¿ç”¨å®˜æ–¹ Theos å®‰è£…å™¨ ==="
        
        # å®˜æ–¹å®‰è£…è„šæœ¬ä¼šè‡ªåŠ¨å¤„ç†å·¥å…·é“¾
        if bash -c "$(curl -fsSL https://raw.githubusercontent.com/theos/theos/master/bin/install-theos)"; then
          echo "âœ… Theos å®‰è£…æˆåŠŸ"
          
          # éªŒè¯å®‰è£…
          if [ -d "$THEOS" ] && [ -f "$THEOS/makefiles/common.mk" ]; then
            echo "âœ… Theos å®‰è£…éªŒè¯æˆåŠŸ"
          else
            echo "âŒ Theos å®‰è£…éªŒè¯å¤±è´¥"
            exit 1
          fi
        else
          echo "âŒ å®˜æ–¹å®‰è£…å™¨å¤±è´¥ï¼Œå°è¯•æ‰‹åŠ¨å®‰è£…"
          
          # å›é€€æ–¹æ¡ˆï¼šæ‰‹åŠ¨å®‰è£…
          sudo git clone --recursive https://github.com/theos/theos.git $THEOS
          sudo chown -R $USER:$USER $THEOS
          
          # ä¸‹è½½å·¥å…·é“¾
          echo "=== ä¸‹è½½ iOS å·¥å…·é“¾ ==="
          mkdir -p $THEOS/toolchain
          
          if curl --max-time 300 -fsSL https://github.com/kabiroberai/toolchain/releases/download/20210228/ios-linux.tar.gz -o /tmp/toolchain.tar.gz; then
            if file /tmp/toolchain.tar.gz | grep -q "gzip compressed"; then
              tar xzf /tmp/toolchain.tar.gz -C $THEOS/toolchain
              rm /tmp/toolchain.tar.gz
              echo "âœ… å·¥å…·é“¾å®‰è£…æˆåŠŸ"
            else
              echo "âŒ å·¥å…·é“¾æ–‡ä»¶æ ¼å¼é”™è¯¯"
              exit 1
            fi
          else
            echo "âŒ å·¥å…·é“¾ä¸‹è½½å¤±è´¥"
            exit 1
          fi
        fi
        
        # ä¸‹è½½ iOS 14.5 SDK
        echo "=== ä¸‹è½½ iOS SDK ==="
        mkdir -p $THEOS/sdks
        
        if curl --max-time 180 -LO https://github.com/theos/sdks/archive/master.zip; then
          if unzip -q master.zip; then
            # ä¼˜å…ˆä½¿ç”¨ iOS 14.x SDK
            if [ -d "sdks-master/iPhoneOS14.5.sdk" ]; then
              cp -r sdks-master/iPhoneOS14.5.sdk $THEOS/sdks/
              echo "âœ… ä½¿ç”¨ iOS 14.5 SDK"
            elif [ -d "sdks-master/iPhoneOS14.4.sdk" ]; then
              cp -r sdks-master/iPhoneOS14.4.sdk $THEOS/sdks/iPhoneOS14.5.sdk
              echo "âœ… ä½¿ç”¨ iOS 14.4 SDK (é‡å‘½åä¸º 14.5)"
            else
              # æ‰¾ä»»ä½• 14.x SDK
              SDK_14=$(find sdks-master -name "iPhoneOS14.*.sdk" -type d | head -1)
              if [ -n "$SDK_14" ]; then
                cp -r "$SDK_14" $THEOS/sdks/iPhoneOS14.5.sdk
                echo "âœ… ä½¿ç”¨ $(basename $SDK_14)"
              else
                # å›é€€åˆ° 13.7 SDK
                if [ -d "sdks-master/iPhoneOS13.7.sdk" ]; then
                  cp -r sdks-master/iPhoneOS13.7.sdk $THEOS/sdks/
                  echo "âš ï¸  ä½¿ç”¨ iOS 13.7 SDK (14.x ä¸å¯ç”¨)"
                else
                  echo "âŒ æ‰¾ä¸åˆ°åˆé€‚çš„ iOS SDK"
                  exit 1
                fi
              fi
            fi
            rm -rf master.zip sdks-master
          else
            echo "âŒ SDK è§£å‹å¤±è´¥"
            exit 1
          fi
        else
          echo "âŒ SDK ä¸‹è½½å¤±è´¥"
          exit 1
        fi

    - name: Verify Theos Installation
      run: |
        echo "=== éªŒè¯ Theos å®‰è£… ==="
        
        if [ -d "$THEOS" ] && [ -f "$THEOS/makefiles/common.mk" ]; then
          echo "âœ… Theos: $THEOS"
        else
          echo "âŒ Theos æœªæ­£ç¡®å®‰è£…"
          exit 1
        fi
        
        # æ£€æŸ¥ SDK
        if [ -d "$THEOS/sdks/iPhoneOS14.5.sdk" ]; then
          echo "âœ… iOS 14.5 SDK å·²å°±ç»ª"
        elif [ -d "$THEOS/sdks/iPhoneOS13.7.sdk" ]; then
          echo "âœ… iOS 13.7 SDK å·²å°±ç»ª"
        else
          echo "âŒ æ‰¾ä¸åˆ° iOS SDK"
          ls -la $THEOS/sdks/
          exit 1
        fi
        
        # æ£€æŸ¥å·¥å…·é“¾ï¼ˆæ”¯æŒå¤šç§å¯èƒ½çš„ä½ç½®ï¼‰
        CLANG_FOUND=false
        for clang_path in \
          "$THEOS/toolchain/linux/iphone/bin/clang" \
          "$THEOS/toolchain/bin/clang" \
          "$(which clang)"; do
          if [ -x "$clang_path" ]; then
            echo "âœ… æ‰¾åˆ°ç¼–è¯‘å™¨: $clang_path"
            CLANG_FOUND=true
            break
          fi
        done
        
        if [ "$CLANG_FOUND" = false ]; then
          echo "âŒ æ‰¾ä¸åˆ°ç¼–è¯‘å™¨"
          exit 1
        fi

    # ============================================
    # ä¿®æ”¹ Makefile ä½¿ç”¨æ­£ç¡®çš„ SDK
    # ============================================
    - name: Configure Makefile for iOS 14.6
      run: |
        echo "=== é…ç½® Makefile ==="
        
        # å¤‡ä»½åŸå§‹ Makefile
        cp Makefile Makefile.backup
        
        # åˆ›å»ºé’ˆå¯¹ iOS 14.6 ä¼˜åŒ–çš„ Makefile
        cat > Makefile << 'MAKEFILE_EOF'
        export TARGET = iphone:clang:14.5:14.0
        export ARCHS = arm64
        INSTALL_TARGET_PROCESSES = SpringBoard
        
        include $(THEOS)/makefiles/common.mk
        
        TWEAK_NAME = VCAM
        
        VCAM_FILES = Tweak.x
        VCAM_CFLAGS = -fobjc-arc -Wno-deprecated-declarations
        VCAM_FRAMEWORKS = UIKit Foundation
        
        include $(THEOS_MAKE_PATH)/tweak.mk
        MAKEFILE_EOF
        
        echo "âœ… Makefile å·²é…ç½®ä¸ºä½¿ç”¨ iOS 14.5 SDK"
        cat Makefile

    # ============================================
    # ç¼–è¯‘é¡¹ç›®
    # ============================================
    - name: Build Project
      env:
        THEOS: ${{ env.THEOS }}
      run: |
        export PATH="$THEOS/bin:$PATH"
        
        echo "=== å¼€å§‹ç¼–è¯‘ VCAM Test ==="
        echo "THEOS: $THEOS"
        echo "TARGET: iOS 14.5 SDK, deployment target 14.0"
        
        if make clean; then
          echo "âœ… æ¸…ç†å®Œæˆ"
        else
          echo "âŒ æ¸…ç†å¤±è´¥"
          exit 1
        fi
        
        if make package FINALPACKAGE=1; then
          echo "âœ… ç¼–è¯‘æˆåŠŸ"
          
          # æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
          if ls packages/*.deb >/dev/null 2>&1 || ls *.deb >/dev/null 2>&1; then
            echo "âœ… deb åŒ…å·²ç”Ÿæˆ"
            ls -lh packages/*.deb *.deb 2>/dev/null || true
            
            # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
            echo ""
            echo "=== ç”Ÿæˆçš„ deb åŒ…ä¿¡æ¯ ==="
            dpkg-deb -I packages/*.deb 2>/dev/null || dpkg-deb -I *.deb 2>/dev/null || true
            
          else
            echo "âŒ æ‰¾ä¸åˆ° deb åŒ…"
            exit 1
          fi
        else
          echo "âŒ ç¼–è¯‘å¤±è´¥"
          exit 1
        fi

    # ============================================
    # éªŒè¯äºŒè¿›åˆ¶å…¼å®¹æ€§
    # ============================================
    - name: Verify Binary Compatibility
      run: |
        echo "=== éªŒè¯äºŒè¿›åˆ¶æ–‡ä»¶ ==="
        
        # è§£å‹ deb æŸ¥çœ‹äºŒè¿›åˆ¶
        DEB_FILE=$(ls packages/*.deb 2>/dev/null | head -1 || ls *.deb 2>/dev/null | head -1)
        
        if [ -f "$DEB_FILE" ]; then
          mkdir -p /tmp/deb_extract
          dpkg-deb -x "$DEB_FILE" /tmp/deb_extract
          
          DYLIB_FILE=$(find /tmp/deb_extract -name "VCAM.dylib" | head -1)
          
          if [ -f "$DYLIB_FILE" ]; then
            echo "âœ… æ‰¾åˆ° dylib: $DYLIB_FILE"
            echo ""
            echo "æ–‡ä»¶ä¿¡æ¯:"
            file "$DYLIB_FILE"
            echo ""
            echo "å¤§å°: $(ls -lh "$DYLIB_FILE" | awk '{print $5}')"
          else
            echo "âŒ æ‰¾ä¸åˆ° VCAM.dylib"
          fi
        else
          echo "âŒ æ‰¾ä¸åˆ° deb æ–‡ä»¶"
        fi

    # ============================================
    # ä¸Šä¼ æ„å»ºäº§ç‰©
    # ============================================
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: VCAM-Test-iOS14.6-${{ github.sha }}
        path: |
          packages/*.deb
          *.deb
        retention-days: 30

    # ============================================
    # ç”Ÿæˆæ„å»ºä¿¡æ¯
    # ============================================
    - name: Generate Build Info
      run: |
        cat > BUILD_INFO.md << 'BUILD_INFO_EOF'
        # VCAM Test Build - iOS 14.6 å…¼å®¹ç‰ˆæœ¬
        
        ## ğŸ¯ æ„å»ºä¿¡æ¯
        
        - **ç‰ˆæœ¬**: Hello World æµ‹è¯•ç‰ˆ
        - **SDK**: iOS 14.5 (æœ€æ¥è¿‘ iOS 14.6)
        - **ç›®æ ‡è®¾å¤‡**: iPhone 12, iOS 14.6
        - **æ¶æ„**: arm64
        - **æœ€ä½æ”¯æŒ**: iOS 14.0
        - **æ„å»ºç¯å¢ƒ**: Ubuntu + Theos (Linux)
        
        ## âœ… è¿™ä¸ªç‰ˆæœ¬çš„ç‰¹ç‚¹
        
        - **ä½¿ç”¨æ—§ç‰ˆ SDK**: iOS 14.5 è€Œé iOS 26.1
        - **æœ€å°åŒ–æµ‹è¯•**: ä»…åŒ…å« Hello World åŠŸèƒ½
        - **å®Œå…¨å…¼å®¹**: ä¸“ä¸º iOS 14.6 ä¼˜åŒ–
        
        ## ğŸ“ æµ‹è¯•è¯´æ˜
        
        ### åŠŸèƒ½
        1. Hook SpringBoard å¯åŠ¨
        2. æ‰“å°ç³»ç»Ÿæ—¥å¿—
        3. æ˜¾ç¤ºæµ‹è¯•å¼¹çª—ï¼ˆ3ç§’åå‡ºç°ï¼‰
        
        ### å®‰è£…
        ```bash
        # ä¼ è¾“åˆ°è®¾å¤‡
        scp -P 2222 *.deb root@localhost:/var/root/
        
        # å®‰è£…
        ssh -p 2222 root@localhost
        dpkg -i /var/root/*.deb
        killall -9 SpringBoard
        ```
        
        ### æœŸæœ›ç»“æœ
        - âœ… SpringBoard æ­£å¸¸é‡å¯
        - âœ… å¼¹å‡º "VCAM Test" æç¤ºæ¡†
        - âœ… ç³»ç»Ÿæ—¥å¿—ä¸­æœ‰ VCAM è¾“å‡º
        - âœ… **ä¸å´©æºƒ**
        
        ### å¦‚æœæˆåŠŸ
        è¯´æ˜é—®é¢˜ç¡®å®æ˜¯ M4 Mac çš„ SDK ç‰ˆæœ¬å¯¼è‡´çš„ï¼ŒåŸé¡¹ç›®ä»£ç æœ¬èº«æ²¡é—®é¢˜ã€‚
        
        ### å¦‚æœå¤±è´¥
        è¯´æ˜å¯èƒ½è¿˜æœ‰å…¶ä»–å…¼å®¹æ€§é—®é¢˜ï¼Œéœ€è¦è¿›ä¸€æ­¥è°ƒè¯•ã€‚
        
        ## ğŸ” æŸ¥çœ‹æ—¥å¿—
        ```bash
        ssh -p 2222 root@localhost
        log show --last 5m --predicate 'eventMessage contains "VCAM"'
        ```
        BUILD_INFO_EOF
        
        # æ·»åŠ æ„å»ºå…ƒæ•°æ®
        echo "" >> BUILD_INFO.md
        echo "---" >> BUILD_INFO.md
        echo "" >> BUILD_INFO.md
        echo "**æ„å»ºæ—¶é—´**: $(date -u)" >> BUILD_INFO.md
        echo "**Commit**: ${{ github.sha }}" >> BUILD_INFO.md
        echo "**åˆ†æ”¯**: ${{ github.ref_name }}" >> BUILD_INFO.md
        
        cat BUILD_INFO.md

    - name: Upload Build Info
      uses: actions/upload-artifact@v4
      with:
        name: build-info-${{ github.sha }}
        path: BUILD_INFO.md

    # ============================================
    # æ„å»ºæ‘˜è¦
    # ============================================
    - name: Build Summary
      if: always()
      run: |
        echo "=================================="
        echo "ğŸ“¦ VCAM Test æ„å»ºå®Œæˆ"
        echo "=================================="
        echo ""
        echo "âœ… SDK: iOS 14.5"
        echo "âœ… ç›®æ ‡: iOS 14.6 (iPhone 12)"
        echo "âœ… æ¶æ„: arm64"
        echo ""
        if ls packages/*.deb *.deb 2>/dev/null; then
          echo "ğŸ“¦ ç”Ÿæˆçš„åŒ…:"
          ls -lh packages/*.deb *.deb 2>/dev/null || true
        fi
        echo ""
        echo "ğŸ’¡ ä¸‹è½½ Artifacts æ¥è·å– deb åŒ…"
